{% extends 'base.html' %}

{% load static %}
{% block css %}
<link href="{% static 'myapp/styles/gamestyle.css' %}" type="text/css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class='game_container'>
    <div class='game_content'>
        <h1>Typing Game <span id="score">0</span> </h1>

        <div id="snippet"></div>
        <div id="typed"></div>
        <div id="remaining"></div>
        <div id="result"></div>
    </div>
</div>
<script>

    const socket = new WebSocket(
        'ws://' + window.location.host + '/ws/typing/'
    );

    let score = document.getElementById('score');
    let snippet = document.getElementById('snippet'); 
    let remaining = document.getElementById('remaining'); 
    let typed = document.getElementById('typed');
    let result = document.getElementById('result');


    socket.onmessage = function(event) {
        console.log('Received message:', event.data);
        let data = JSON.parse(event.data);

        if (data.game_over) {
            snippet.innerText = 'Game Over! You have completed all snippets.';
            typed.innerText = '';
            remaining.innerText = '';
            result.innerText = '';
            document.removeEventListener('keydown', keydownHandler);
        }else{
            snippet.innerText = data.snippet_text;
            typed.innerText =  data.typed_text;
            remaining.innerText = snippet.innerText.slice(typed.innerText.length);
        } 
        if (data.is_correct ){
            typed.innerText = '';
            result.innerText = '';
            score.innerText = data.player_score;
        }
    };

    const keydownHandler = (event) => {
        let key = event.key;

        if (key.length === 1 && /[a-z .]/i.test(key) ) {
            if (key === snippet.innerText[typed.innerText.length]) {
                if(key == " "){            
                    console.log('its space !!!!!!');
                    typed.innerText +=  ' ';
                }else{
                    typed.innerText +=  key.toLowerCase();
                }
                remaining.innerText = snippet.innerText.slice(typed.innerText.length);
                result.innerText = '';
            } else {
                result.innerText = 'Incorrect key pressed!';
            }
        }
        else if (key === 'Backspace') {
            if (typed.innerText.length > 0) {
                typed.innerText = typed.innerText.slice(0, -1);
                remaining.innerText = snippet.innerText.slice(typed.innerText.length);
            }
        }

        let message = JSON.stringify({
            'snippet_text':snippet.innerText,
            'typed_text': typed.innerText,
            'remaining_text': remaining.innerText,
        });

        if (socket.readyState === WebSocket.OPEN) {
            console.log('Sending message:', message);
            socket.send(message);
        } else {
            console.error('WebSocket is not open. Current state:', socket.readyState);
        }
    };

    document.addEventListener('keydown', keydownHandler);

    socket.onopen = function() {console.log('WebSocket connection established');};
    socket.onclose = function(event) {console.log('WebSocket closed with code:', event.code, 'and reason:', event.reason);};
    socket.onerror = function(error) {console.log('WebSocket error:', error);};
</script>
{% endblock %}
