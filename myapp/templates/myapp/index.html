{% extends 'base.html' %}

{% load static %}
{% block css %}
<link href="{% static 'myapp/styles/gamestyle.css' %}" type="text/css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class='game_container'>
    <div class='game_content'>
        <h1>Typing Game</h1>
        <div id="snippet"></div>
        <div id="typed"></div>
        <div id="remaining"></div>
        <div id="result"></div>
    </div>
</div>
<script>

    const socket = new WebSocket(
        'ws://' + window.location.host + '/ws/typing/'
    );

    let snippetText = "";
    let typedText = "";

    socket.onmessage = function(event) {
        console.log('Received message:', event.data);
        let data = JSON.parse(event.data);

        if (data.game_over) {
            document.getElementById('snippet').innerText = 'Game Over! You have completed all snippets.';
            document.getElementById('remaining').innerText = '';
            document.getElementById('typed').innerText = '';
            document.getElementById('result').innerText = '';
            document.removeEventListener('keydown', keydownHandler);
        }else{
            document.getElementById('snippet').innerText = data.snippet_text;
            document.getElementById('typed').innerText =  data.typed_text;
            document.getElementById('remaining').innerText = data.snippet_text.slice( data.typed_text.length);
            document.getElementById('result').innerText = data.is_correct ? 'Correct!' : '';
        } 
        if (data.is_correct ){
            document.getElementById('typed').innerText = '';
            document.getElementById('result').innerText = '';
        }
    };

    const keydownHandler = (event) => {
        let key = event.key;
        let typedText=document.getElementById('typed').innerText ;
        let snippetText=document.getElementById('snippet').innerText;
        let remainingText=document.getElementById('remaining').innerText;

        if (key.length === 1 && /[a-z .]/.test(key) ) {
            if (key === snippetText[typedText.length]) {
                typedText += key.toLowerCase();
                document.getElementById('typed').innerText = typedText;
                document.getElementById('remaining').innerText = snippetText.slice(typedText.length);
            } else {
                document.getElementById('result').innerText = 'Incorrect key pressed!';
            }
        } else if (key === 'Backspace') {
            if (typedText.length > 0) {
                typedText = typedText.slice(0, -1);
                document.getElementById('typed').innerText = typedText;
                document.getElementById('remaining').innerText = snippetText.slice(typedText.length);
            }
        }

        let message = JSON.stringify({
            'snippet_text':snippetText,
            'typed_text': typedText,
            'remaining_text': remainingText,
        });

        if (socket.readyState === WebSocket.OPEN) {
            console.log('Sending message:', message);
            socket.send(message);
        } else {
            console.error('WebSocket is not open. Current state:', socket.readyState);
        }
    };

    document.addEventListener('keydown', keydownHandler);

    socket.onopen = function() {console.log('WebSocket connection established');};
    socket.onclose = function(event) {console.log('WebSocket closed with code:', event.code, 'and reason:', event.reason);};
    socket.onerror = function(error) {console.log('WebSocket error:', error);};
</script>
{% endblock %}
